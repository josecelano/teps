|TEP: 0013|Bencode to JSON conversion|
|-:|:---|
|__Layer:__|Community|
|__Authors:__|Jose Celano|
|__Status:__|Draft|
|__Discussion:__|<https://github.com/torrust/teps/issues/16>|
|__Type:__|Standards Track|
|__Created:__|2024-10-22|
|__Updated:__|2024-10-22|
|__Resolution:__| Pending|

## Abstract

This document proposes a standard for converting data between Bencode, the encoding format used by the BitTorrent protocol, and JSON (JavaScript Object Notation), a widely-used data interchange format. The primary challenge addressed is the representation of binary data in JSON, which is inherently text-based and encodes strings in UTF-8. This proposal recommends using hexadecimal encoding for binary data within JSON and provides a JSON schema for all valid converted objects.

## Copyright

This document is licensed under the 2-clause BSD licence.

## Detailed description

Bencode is a binary format widely used in peer-to-peer file sharing systems, particularly BitTorrent. JSON, on the other hand, is a widely-used data interchange format. There are
many situations when converting between these formats is desirable. For example, it's very
common for console apps or REST APIs to accept JSON as input and output. Those application can handle information that was primarily encoded in Bencode, but not JSON. In those
situations, it would be useful to be able to convert between the two formats.

One use case that motivated this TEP is the need to convert between Bencode and JSON in the context of a BitTorrent client. BitTorrent clients often need to convert between Bencode and JSON to interact with other applications or services. For example, Torrust had developed
tracker clients that handle responses from trackers. Users and developers of those clients
very often need to easily analyze the data received from trackers. For example, if you are using a HTTP tracker client you might want to convert the bencoded `announce` response into JSON to read it easily. In other cases, you might receive an unexpected response from a tracker. Showing the original bytes in a error message can be hard to read.

Bencoded to JSON conversion is not a complex task, because they have similar types. BEncoded values are:

- Integers.
- Strings.
- Lists.
- Dictionaries.

All of them are directly mapped to JSON values. However, there are some differences between them. String in Bencode is a sequence of bytes, while in JSON it is a sequence of Unicode characters, meaning not all strings in Bencode can be represented in JSON. For example, the
following bencoded value:

```text
d3:bar2:\xFF\xFEe
```

can't be represented in JSON because it contain two bytes that are not a valid UTF-8 sequence.

Out proposal is to use hexadecimal encoding for binary data within JSON. This approach allows for the representation of binary data in a way that is compatible with JSON and UTF-8.

```json
{"bar":"<hex>fffe</hex>"}
```

There are other ways to represent binary data in JSON, such as Base64 encoding, but we thing that hexadecimal encoding is the best option because:

- It is a well-known and widely-used encoding format.
- It is a simple and easy-to-understand encoding format.
- As JSON is an easy-to-read text format, hexadecimal encoding is easy to read and understand.

In short, it keeps the original JSON purpose, that is, to provide a way to represent data in a human-readable and machine-readable format.

The main disadvantage of hexadecimal encoding is that it is not a compact encoding format. Each byte of binary data becomes two characters in JSON. However, we think that the benefits of using hexadecimal encoding outweigh the disadvantages.

## Implementation

There could be many ways to implement this TEP. We have chosen to implement it in Rust, but  it could be implemented in any programming language.

We have created a reference implementation of the TEP in the [torrust/bencode-to-json](https://github.com/torrust/bencode2json) repository.

The reference implementation was developed with some requirements in mind:

- It should be easy to use.
- It should be easy to understand.
- It should be easy to maintain.
- It should be easy to test.
- It should be easy to extend.
- It should be easy to integrate with other projects.
- It should allow converting big bencoded values like big torrent files.
- It should not consume too much memory, avoiding intermediary in-memory data structures.
- It should be fast.
- It should allow different types of inputs and outputs (files, sdtin, stdout, etc).

## Compatibility

This TEP follows the specifications of a [previous implementation](https://github.com/Chocobo1/bencode_online) in TypeScript.

## Alternative representations for non-UTF8 sequences

Other methods considered and discarded include:

- Base64 Encoding: Converts binary data into a base-64 representation. While efficient in terms of space, it is less human-readable and can complicate encoding and decoding processes.

- Array Representation: Involves representing binary data as an array of byte values in JSON. This method is inefficient in terms of space and handling. Besides, it will imply to use two different values in the JSON value, one for UTF8 sequences (JSON strings) and one for non-UTF8 sequences (arrays of numbers).

- Escape Non-UTF8 Sequences: Attempts to represent binary data as UTF-8 strings by escaping invalid sequences. This approach is complex and not universally applicable.

- Custom Encoding Scheme: Utilizes a custom scheme for specific types of binary data. This method would require custom logic for parsing and is less generalizable.

## Alternative implementations

There are other implementations in other languages, but only one of them follows the same specification, the [Chocobo1's implementation](https://github.com/Chocobo1/bencode_online).

- <https://github.com/Chocobo1/bencode_online>
- <https://adrianstoll.com/post/bencoding/>
- <https://www.nayuki.io/page/bittorrent-bencode-format-tools>
- <https://gist.github.com/camilleoudot/840929699392b3d25afbec25d850c94a>
- <https://github.com/denis-selimovic/bencode>
- <https://github.com/maxyodedara5/BencodeToJson>

## JSON schema

The JSON schema for representing Bencode data in JSON is as follows:

```json
{
  "$schema": "http://json-schema.org/draft/2020-12/schema",
  "title": "Bencode to JSON Schema",
  "description": "Schema for JSON objects converted from Bencode format, with strict integer validation",
  "definitions": {
    "bencodeInteger": {
      "type": "integer",
      "pattern": "^[-]?\\d+$",
      "examples": ["123", "-456", "+789", "123.00"]
    },
    "bencodeString": {
      "type": "string",
      "description": "Bencode string (with <hex></hex> delimiters if byte sequence is not valid UTF-8)"
    },
    "bencodeList": {
      "type": "array",
      "description": "Bencode list",
      "items": { "$ref": "#/definitions/bencodeValue" },
      "minItems": 0
    },
    "bencodeDictionary": {
      "type": "object",
      "description": "Bencode dictionary",
      "patternProperties": {
        "^.*$": { "$ref": "#/definitions/bencodeValue" }
      },
      "additionalProperties": false
    },
    "bencodeValue": {
      "oneOf": [
        { "$ref": "#/definitions/bencodeInteger" },
        { "$ref": "#/definitions/bencodeString" },
        { "$ref": "#/definitions/bencodeList" },
        { "$ref": "#/definitions/bencodeDictionary" }
      ]
    }
  },
  "oneOf": [
    { "$ref": "#/definitions/bencodeInteger" },
    { "$ref": "#/definitions/bencodeString" },
    { "$ref": "#/definitions/bencodeList" },
    { "$ref": "#/definitions/bencodeDictionary" }
  ],
  "examples": [
    4255,
    "spam",
    "<hex>fffe</hex>",
    [],
    [1, "hello", "<hex>abcd</hex>"],
    {
      "key1": 100,
      "key2": "<hex>abcd</hex>"
    }
  ]
}
```

Valid values:

```text
1
"spam"
"<hex>aa</hex>"
[]
{}
[1]
["spam"]
[1, "spam", "<hex>aa</hex>"]
[[]]
[[[]]]
{"foo":{}}
{"foo":{"foo":{}}}
[{}]
{"foo":[]}
```

Invalid values:

```text
1.1
1,1
[
{
[1
{"foo"
{"foo"}
```

JSON Schema can be validated on: <https://www.jsonschemavalidator.net/>.

## Discussion

The discussion for this TEP is on a [GitHub Issue](https://github.com/torrust/teps/issues/16).

You might also be interested in the GitHub repository for the [reference implementation](https://github.com/torrust/bencode2json).

## References and Footnotes

- [Previous implementation in TypeScript](<https://github.com/Chocobo1/bencode_online>).
- [The C implementation that was the base for the Rust reference implementation](<https://gist.github.com/camilleoudot/840929699392b3d25afbec25d850c94a>)
